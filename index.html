<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Cakes - Custom Order Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Nunito:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #fdf2f8; /* Soft Pink Background */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        h1, h2, h3 {
            font-family: 'Lora', serif;
        }
        .step {
            display: none;
            animation: fadeIn 0.7s ease-in-out;
        }
        .step.active {
            display: block;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.4);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .option-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform: translateY(0);
        }
        .option-card:hover {
             transform: translateY(-5px);
             box-shadow: 0 10px 20px rgba(0,0,0,0.08);
        }
        .option-card.selected {
            transform: scale(1.05) translateY(-5px);
            border-color: #c026d3; /* Fuchsia-700 */
            box-shadow: 0 8px 25px rgba(192, 38, 211, 0.2);
        }
        .generated-image-option {
            cursor: pointer;
            border: 4px solid transparent;
            transition: border-color 0.3s ease;
        }
        .generated-image-option.selected {
            border-color: #c026d3; /* Fuchsia-700 */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #c026d3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stagger-in > * {
            animation: fadeIn 0.5s ease-out both;
        }
        .stagger-in > *:nth-child(1) { animation-delay: 0.1s; }
        .stagger-in > *:nth-child(2) { animation-delay: 0.2s; }
        .stagger-in > *:nth-child(3) { animation-delay: 0.3s; }
        .stagger-in > *:nth-child(4) { animation-delay: 0.4s; }
        .stagger-in > *:nth-child(5) { animation-delay: 0.5s; }
        .stagger-in > *:nth-child(6) { animation-delay: 0.6s; }
    </style>
</head>
<body class="bg-pink-50 text-stone-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8 animate-fadeIn" style="animation-delay: 0.1s;">
            <h1 class="text-4xl md:text-6xl font-bold text-stone-800">Dream Cakes</h1>
            <p class="text-lg text-pink-600 mt-2">Handcrafted with love in Australia</p>
        </header>

        <div class="glassmorphism rounded-3xl shadow-2xl p-6 md:p-10 animate-fadeIn" style="animation-delay: 0.3s;">
            <form id="cake-form" onsubmit="return false;">
                <!-- Step 1: Type -->
                <div id="step-type" class="step active">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-stone-800">What are you looking for today?</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 stagger-in">
                        <div class="option-card border-2 bg-white/50 border-gray-200 rounded-2xl p-6 text-center cursor-pointer" onclick="selectOption(this, 'type', 'Custom Cake', 20.00)">
                            <div class="text-6xl mb-3">üéÇ</div>
                            <h3 class="text-xl font-semibold text-stone-700">Custom Cake</h3>
                            <p class="text-sm text-gray-600">Multi-tiered or single-tiered cakes for any occasion.</p>
                        </div>
                        <div class="option-card border-2 bg-white/50 border-gray-200 rounded-2xl p-6 text-center cursor-pointer" onclick="selectOption(this, 'type', 'Cupcakes', 4.00)">
                             <div class="text-6xl mb-3">üßÅ</div>
                            <h3 class="text-xl font-semibold text-stone-700">Cupcakes</h3>
                            <p class="text-sm text-gray-600">Delicious batches of custom cupcakes.</p>
                        </div>
                    </div>
                </div>

                <!-- Step 1.5: Occasion -->
                <div id="step-occasion" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-stone-800">What's the occasion?</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 stagger-in">
                        <button type="button" onclick="selectOccasion(this, 'Birthday')" class="option-card border-2 bg-white/50 p-4 rounded-xl">Birthday</button>
                        <button type="button" onclick="selectOccasion(this, 'Wedding')" class="option-card border-2 bg-white/50 p-4 rounded-xl">Wedding</button>
                        <button type="button" onclick="selectOccasion(this, 'Anniversary')" class="option-card border-2 bg-white/50 p-4 rounded-xl">Anniversary</button>
                        <button type="button" onclick="selectOccasion(this, 'Baby Shower')" class="option-card border-2 bg-white/50 p-4 rounded-xl">Baby Shower</button>
                    </div>
                     <div class="mt-8 text-center">
                        <button type="button" onclick="goToNextStep()" class="text-sm text-gray-600 hover:text-stone-700">I'll describe it myself</button>
                    </div>
                    <div id="theme-suggestions-container" class="mt-6" style="display: none;">
                        <h3 class="text-xl font-bold text-stone-700 mb-4 text-center">Here are a few ideas...</h3>
                        <div id="theme-suggestions-loader" class="flex justify-center items-center" style="display: none;">
                            <div class="loader"></div>
                            <p class="ml-4 text-stone-600">Generating themes...</p>
                        </div>
                        <div id="theme-suggestions-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4 stagger-in">
                            <!-- Theme suggestions will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Step 2a: Servings (for Custom Cake) -->
                <div id="step-servings" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-stone-800">How many people will it serve?</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 stagger-in">
                        <button type="button" onclick="selectOption(this, 'servings', 'Up to 8', 25.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Up to 8</button>
                        <button type="button" onclick="selectOption(this, 'servings', 'Up to 25', 55.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Up to 25</button>
                        <button type="button" onclick="selectOption(this, 'servings', 'Up to 40', 80.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Up to 40</button>
                        <button type="button" onclick="selectOption(this, 'servings', 'Up to 50', 100.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Up to 50</button>
                    </div>
                </div>

                <!-- Step 2b: Tiers (for Custom Cake) -->
                <div id="step-tier" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-stone-800">Select the number of tiers</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 stagger-in">
                        <button type="button" onclick="selectOption(this, 'tier', 'Single-Tier', 0)" class="option-card border-2 bg-white/50 p-6 rounded-2xl">Single-Tier</button>
                        <button type="button" onclick="selectOption(this, 'tier', 'Two-Tier', 40.00)" class="option-card border-2 bg-white/50 p-6 rounded-2xl">Two-Tier</button>
                    </div>
                </div>

                <!-- Step 2c: Cupcake Quantity -->
                 <div id="step-cupcake-quantity" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-stone-800">How many cupcakes?</h2>
                    <label for="cupcake_quantity" class="block text-sm font-medium text-gray-700">Quantity (min 6, max 60)</label>
                    <input type="number" id="cupcake_quantity" name="cupcake_quantity" min="6" max="60" value="6" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm p-3">
                    <button type="button" onclick="setCupcakeQuantity()" class="w-full bg-fuchsia-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-fuchsia-700 transition mt-4 shadow-lg">Confirm Quantity</button>
                </div>


                <!-- Step 3: Flavour -->
                <div id="step-flavour" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-stone-800">Choose a flavour</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 stagger-in">
                        <button type="button" onclick="selectOption(this, 'flavour', 'Chocolate', 5.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Chocolate</button>
                        <button type="button" onclick="selectOption(this, 'flavour', 'Vanilla', 0)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Vanilla</button>
                        <button type="button" onclick="selectOption(this, 'flavour', 'Red Velvet', 5.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Red Velvet</button>
                        <button type="button" onclick="selectOption(this, 'flavour', 'Butter Scotch', 7.50)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Butter Scotch</button>
                        <button type="button" onclick="selectOption(this, 'flavour', 'Carrot', 7.50)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Carrot</button>
                    </div>
                </div>

                <!-- Step 4: Fillings -->
                <div id="step-fillings" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-stone-800">Add a filling?</h2>
                    <div class="text-center mb-6">
                        <button type="button" id="suggest-filling-btn" onclick="getFillingSuggestions()" class="bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:scale-105 transition-transform text-sm">
                            ‚ú® Get Expert Advice
                        </button>
                    </div>
                    <div id="filling-suggestions-container" class="mb-6 p-4 bg-pink-50/50 border border-pink-200 rounded-xl" style="display: none; animation: fadeIn 0.5s;">
                        <!-- Filling suggestions will be injected here -->
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 stagger-in">
                         <button type="button" onclick="selectOption(this, 'filling', 'Nutella', 10.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Nutella</button>
                         <button type="button" onclick="selectOption(this, 'filling', 'Biscoff', 10.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Biscoff</button>
                         <button type="button" onclick="selectOption(this, 'filling', 'Cream Cheese', 8.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Cream Cheese</button>
                         <button type="button" onclick="selectOption(this, 'filling', 'Salted Caramel', 8.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Salted Caramel</button>
                         <button type="button" onclick="selectOption(this, 'filling', 'Berry Jam', 7.00)" class="option-card border-2 bg-white/50 p-4 rounded-xl">Berry Jam</button>
                         <button type="button" onclick="selectOption(this, 'filling', 'None', 0)" class="option-card border-2 bg-white/50 p-4 rounded-xl">No, thanks</button>
                    </div>
                </div>

                <!-- Step 5: File Upload -->
                <div id="step-upload" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 text-center text-stone-800">Have an inspiration picture?</h2>
                    <p class="text-center text-gray-600 mb-6">Upload an image, and our AI will analyze it to help with your design. (Optional)</p>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-2xl">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="file-upload" class="relative cursor-pointer bg-white/50 rounded-md font-medium text-pink-600 hover:text-pink-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-pink-500 px-2">
                                    <span>Upload a file</span>
                                    <input id="file-upload" name="file-upload" type="file" class="sr-only" onchange="handleImageUpload(event)">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                        </div>
                    </div>
                     <div id="image-preview-container" class="mt-4 text-center" style="display: none;">
                        <img id="image-preview" class="max-h-48 mx-auto rounded-lg shadow-md" />
                        <div id="upload-loader" class="mt-4 flex justify-center items-center" style="display: none;">
                             <div class="loader"></div>
                            <p class="ml-4 text-stone-600">Compressing and analyzing image...</p>
                        </div>
                    </div>
                    <button type="button" onclick="goToNextStep()" class="w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-500 transition mt-6">Skip this step</button>
                </div>


                <!-- Step 6: Customization -->
                <div id="step-customization" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 text-center text-stone-800">Describe your desired customization</h2>
                     <p class="text-center text-gray-600 mb-6">Tell us about the theme, colors, text, or any specific decorations you want.</p>
                    <textarea id="customization" name="customization" rows="4" class="p-3 shadow-sm focus:ring-pink-500 focus:border-pink-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-xl" placeholder="e.g., 'A unicorn-themed cake with pastel rainbow frosting, gold horn, and a name 'Chloe' in cursive.'"></textarea>
                    <button type="button" onclick="confirmCustomization()" class="w-full bg-fuchsia-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-fuchsia-700 transition mt-4 shadow-lg">Confirm Customization</button>
                </div>

                <!-- Step 7: Date -->
                <div id="step-date" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 text-center text-stone-800">When do you need it?</h2>
                    <p class="text-center text-gray-600 mb-6">Please allow a minimum of 5 days for us to create your dream cake.</p>
                    <input type="date" id="collection_date" name="collection_date" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 focus:ring-pink-500 focus:border-pink-500">
                    <p id="date-error" class="text-red-500 text-sm mt-2" style="display:none;">Please select a date at least 5 days from now.</p>
                    <button type="button" onclick="confirmDate()" class="w-full bg-fuchsia-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-fuchsia-700 transition mt-4 shadow-lg">Set Collection Date</button>
                </div>

                 <!-- Step 8: Contact Details -->
                <div id="step-contact" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-stone-800">Your Contact Details</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="customer_name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="customer_name" name="customer_name" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 focus:ring-pink-500 focus:border-pink-500" required>
                        </div>
                         <div>
                            <label for="delivery_address" class="block text-sm font-medium text-gray-700">Delivery Address</label>
                            <input type="text" id="delivery_address" name="delivery_address" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 focus:ring-pink-500 focus:border-pink-500" placeholder="e.g. 123 Cake St, Sydney NSW 2000" required>
                        </div>
                         <div>
                            <label for="contact_number" class="block text-sm font-medium text-gray-700">Contact Number</label>
                            <input type="tel" id="contact_number" name="contact_number" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 focus:ring-pink-500 focus:border-pink-500" required>
                        </div>
                         <div>
                            <label for="email_address" class="block text-sm font-medium text-gray-700">Email Address (Optional)</label>
                            <input type="email" id="email_address" name="email_address" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 focus:ring-pink-500 focus:border-pink-500">
                        </div>
                    </div>
                     <button type="button" onclick="confirmContactDetails()" class="w-full bg-fuchsia-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-fuchsia-700 transition mt-6 shadow-lg">Confirm Details</button>
                </div>
                
                <!-- Step 9: Final Summary & Generation -->
                <div id="step-summary" class="step">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-stone-800">Review Your Creation</h2>
                    <p class="text-center text-gray-600 mb-6">Generate an AI preview, and when you're ready, send your enquiry!</p>
                    
                    <div id="generation-container" class="text-center p-4 border border-gray-200 rounded-2xl">
                        <button type="button" id="generate-button" onclick="generateCakeImage()" class="bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:scale-105 transition-transform">
                            ‚ú® Generate My Cake Preview
                        </button>
                        <div id="generation-loader" class="mt-4 flex justify-center items-center" style="display: none;">
                            <div class="loader"></div>
                            <p class="ml-4 text-stone-600">Our AI baker is whipping up your preview...</p>
                        </div>
                         <div id="generated-image-container" class="mt-6" style="display: none;">
                            <h3 class="text-xl font-bold text-stone-700 mb-4">Choose your favorite preview:</h3>
                            <div id="generated-image-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4 stagger-in">
                                <!-- AI Images will be injected here -->
                            </div>
                             <button type="button" id="regenerate-button" onclick="generateCakeImage()" style="display: none;" class="mt-4 text-sm text-stone-600 hover:text-stone-800">
                                üîÑ Regenerate Options
                            </button>
                        </div>
                    </div>

                    <div id="enquiry-section" class="mt-8 text-center">
                         <button type="button" id="send-enquiry-button" onclick="sendEnquiry()" class="bg-green-600 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-green-700 hover:scale-105 transition-transform text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            üìß Send Enquiry
                        </button>
                        <div id="enquiry-confirmation" style="display: none;" class="mt-4 p-4 bg-green-100 text-green-800 rounded-xl">
                           <!-- Success message is inserted here -->
                        </div>
                    </div>

                </div>

            </form>

            <!-- Pricing and Summary Sidebar -->
            <div id="summary-sidebar" class="mt-10 pt-6 border-t-2 border-pink-200">
                <h3 class="text-2xl font-bold text-center text-stone-700 mb-4">Order Summary</h3>
                <div id="summary-content" class="text-gray-700 space-y-2 px-4">
                    <p>Start designing your cake to see the summary.</p>
                </div>
                <div class="mt-6 text-center">
                    <p class="text-lg font-medium text-stone-700">Estimated Price:</p>
                    <p id="total-price" class="text-4xl font-bold text-pink-600">$0.00</p>
                </div>
                 <div class="mt-6 text-center">
                    <button type="button" onclick="resetCalculator()" class="text-sm text-gray-500 hover:text-stone-600">Start Over</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let currentStep = 1;
        const orderDetails = {
            type: null,
            occasion: null,
            servings: null,
            tier: null,
            quantity_cupcake: 0,
            flavour: null,
            filling: null,
            customization: '',
            collection_date: null,
            inspiration_image_data: null, // Store compressed Base64 data
            selected_ai_preview_data: null, // Store compressed Base64 data
            customer_name: '',
            delivery_address: '',
            contact_number: '',
            email_address: '',
        };
        let selected_generated_image_index = null;

        const prices = {
            type: 0,
            servings: 0,
            tier: 0,
            quantity_cupcake: 0,
            flavour: 0,
            filling: 0,
            customization: 0,
        };

        // --- NAVIGATION ---
        function goToStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            const stepId = getStepId(stepNumber);
            if (stepId) {
                const stepElement = document.getElementById(`step-${stepId}`);
                if (stepElement) {
                    stepElement.classList.add('active');
                    currentStep = stepNumber;
                }
            }
        }

        function getFlow() {
            if (orderDetails.type === 'Cupcakes') {
                return ['type', 'occasion', 'cupcake-quantity', 'flavour', 'fillings', 'upload', 'customization', 'date', 'contact', 'summary'];
            }
            return ['type', 'occasion', 'servings', 'tier', 'flavour', 'fillings', 'upload', 'customization', 'date', 'contact', 'summary'];
        }

        function getStepId(stepNumber) {
            const flow = getFlow();
            return flow[stepNumber - 1];
        }

        function goToNextStep() {
            goToStep(currentStep + 1);
        }

        // --- SELECTION & LOGIC ---
        function selectOption(element, key, value, price) {
            element.parentElement.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            
            orderDetails[key] = value;
            prices[key] = price;
            
            updateSummary();
            updatePrice();
            goToNextStep();
        }

        function selectOccasion(element, occasion) {
            element.parentElement.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            orderDetails.occasion = occasion;
            getThemeIdeas();
        }
        
        function confirmCustomization() {
            orderDetails.customization = document.getElementById('customization').value;
            prices.customization = orderDetails.customization ? 15.00 : 0;
            updateSummary();
            updatePrice();
            goToNextStep();
        }

        function setCupcakeQuantity() {
            const quantityInput = document.getElementById('cupcake_quantity');
            const quantity = parseInt(quantityInput.value);
            if (quantity >= 6 && quantity <= 60) {
                orderDetails.quantity_cupcake = quantity;
                prices.quantity_cupcake = quantity * 4.00; 
                prices.type = 0;
                updateSummary();
                updatePrice();
                goToNextStep();
            } else {
                alert('Please enter a quantity between 6 and 60.');
            }
        }
        
        function confirmDate() {
            const dateInput = document.getElementById('collection_date');
            const errorEl = document.getElementById('date-error');
            
            const minSelectableDate = new Date();
            minSelectableDate.setHours(0, 0, 0, 0);
            minSelectableDate.setDate(minSelectableDate.getDate() + 5);
            
            const selectedDate = new Date(dateInput.value + 'T00:00:00');

            if (dateInput.value && selectedDate >= minSelectableDate) {
                orderDetails.collection_date = dateInput.value;
                errorEl.style.display = 'none';
                updateSummary();
                goToNextStep();
            } else {
                errorEl.style.display = 'block';
            }
        }

        function confirmContactDetails() {
            const name = document.getElementById('customer_name').value;
            const address = document.getElementById('delivery_address').value;
            const number = document.getElementById('contact_number').value;
            if (!name || !address || !number) {
                alert('Please fill out all required contact fields.');
                return;
            }
            orderDetails.customer_name = name;
            orderDetails.delivery_address = address;
            orderDetails.contact_number = number;
            orderDetails.email_address = document.getElementById('email_address').value;

            updateSummary();
            goToNextStep();
        }

        function setMinDate() {
            const dateInput = document.getElementById('collection_date');
            const minDate = new Date();
            minDate.setDate(minDate.getDate() + 5);
            dateInput.min = minDate.toISOString().split('T')[0];
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary-content');
            let html = '';
            
            if (orderDetails.type) html += `<p><strong>Type:</strong> ${orderDetails.type}</p>`;
            if (orderDetails.occasion) html += `<p><strong>Occasion:</strong> ${orderDetails.occasion}</p>`;
            if (orderDetails.servings) html += `<p><strong>Serves:</strong> ${orderDetails.servings}</p>`;
            if (orderDetails.tier) html += `<p><strong>Tiers:</strong> ${orderDetails.tier}</p>`;
            if (orderDetails.quantity_cupcake > 0) html += `<p><strong>Quantity:</strong> ${orderDetails.quantity_cupcake} cupcakes</p>`;
            if (orderDetails.flavour) html += `<p><strong>Flavour:</strong> ${orderDetails.flavour}</p>`;
            if (orderDetails.filling) html += `<p><strong>Filling:</strong> ${orderDetails.filling}</p>`;
            if (orderDetails.customization) html += `<p class="truncate"><strong>Notes:</strong> ${orderDetails.customization}</p>`;
            if (orderDetails.collection_date) html += `<p><strong>Collection Date:</strong> ${new Date(orderDetails.collection_date + 'T00:00:00').toDateString()}</p>`;
            if (orderDetails.customer_name) html += `<p class="mt-4 pt-4 border-t border-pink-200"><strong>Name:</strong> ${orderDetails.customer_name}</p>`;
            if (orderDetails.delivery_address) html += `<p><strong>Address:</strong> ${orderDetails.delivery_address}</p>`;
            if (orderDetails.contact_number) html += `<p><strong>Contact:</strong> ${orderDetails.contact_number}</p>`;

            summaryDiv.innerHTML = html || '<p>Start designing your cake to see the summary.</p>';
        }

        function updatePrice() {
            let total = 0;
            if(orderDetails.type === 'Cupcakes' && orderDetails.quantity_cupcake > 0) {
                prices.quantity_cupcake = orderDetails.quantity_cupcake * 4.00;
            }
            total = Object.values(prices).reduce((sum, price) => sum + price, 0);
            document.getElementById('total-price').innerText = `$${total.toFixed(2)}`;
        }

        // --- IMAGE HANDLING & AI ---
        function compressImage(base64String, maxWidth = 800, quality = 0.9) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = base64String;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = img.width > maxWidth ? maxWidth / img.width : 1;
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = error => reject(error);
            });
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadLoader = document.getElementById('upload-loader');
            uploadLoader.style.display = 'flex';

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Data = e.target.result;
                document.getElementById('image-preview').src = base64Data;
                document.getElementById('image-preview-container').style.display = 'block';

                try {
                    const compressedData = await compressImage(base64Data);
                    orderDetails.inspiration_image_data = compressedData;
                    await analyzeImage(compressedData.split(',')[1]);
                } catch (error) {
                    alert("Could not process the uploaded image. Please try a different one.");
                    orderDetails.inspiration_image_data = base64Data; // Fallback
                    await analyzeImage(base64Data.split(',')[1]);
                } finally {
                    uploadLoader.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }

        async function analyzeImage(base64ImageData) {
            const productType = orderDetails.type === 'Cupcakes' ? 'cupcake' : 'cake';
            const prompt = `You are a professional cake designer. The user has selected that they want a ${productType}. Analyze the provided image for inspiration for this ${productType}. Even if the image is of a different baked good, describe its elements as if they were to be applied to a ${productType}. Structure your description clearly. Cover these points: 1. Overall Theme/Style. 2. Shape and Tiers (if applicable). 3. Color Palette. 4. Frosting Technique. 5. Key Decorations.`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } } ] }] }) });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    document.getElementById('customization').value = result.candidates[0].content.parts[0].text;
                }
            } catch (error) {
                console.error('Error during image analysis:', error);
            } finally {
                setTimeout(() => goToNextStep(), 500);
            }
        }
        
        async function generateCakeImage() {
            const loader = document.getElementById('generation-loader');
            const button = document.getElementById('generate-button');
            const imageContainer = document.getElementById('generated-image-container');
            const imageGrid = document.getElementById('generated-image-grid');
            const regenerateBtn = document.getElementById('regenerate-button');

            loader.style.display = 'flex';
            button.style.display = 'none';
            imageGrid.innerHTML = ''; 
            imageContainer.style.display = 'none';
            regenerateBtn.style.display = 'none';
            selected_generated_image_index = null;
            orderDetails.selected_ai_preview_data = null;
            
            const productType = orderDetails.type === 'Cupcakes' ? 'a batch of cupcakes' : 'a custom cake';

            let prompt = `Generate a high-quality, photorealistic image of ${productType}, presented in a professional food photography style on a clean, simple background (like a marble countertop or a cake stand).\n\n`;
            if (orderDetails.inspiration_image_url) { 
                prompt += `CRITICAL INSTRUCTION: This design is heavily inspired by an image provided by the customer. The generated image should VERY CLOSELY resemble the style, colors, decorations, and overall theme of the inspiration image, while integrating the specific details listed below.\n\n`;
            }
            prompt += `--- CORE DETAILS ---\nProduct: ${orderDetails.type}\n`;
            if (orderDetails.type === 'Custom Cake') {
                prompt += `Tiers: ${orderDetails.tier || 'Single-Tier'}\nSize Appearance: Suitable for ${orderDetails.servings || 'a small group'}\n`;
            } else {
                prompt += `Quantity: A batch of ${orderDetails.quantity_cupcake || 6} cupcakes\n`;
            }
            prompt += `Main Flavour (influence color palette): ${orderDetails.flavour}\n`;
            if (orderDetails.filling && orderDetails.filling !== 'None') {
                prompt += `Main Filling (might be visible): ${orderDetails.filling}\n`;
            }
            prompt += `\n--- THEME & CUSTOMIZATION ---\nFollow this detailed description: ${orderDetails.customization}\n`;
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 3 } };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0) {
                    result.predictions.forEach((prediction, index) => {
                        const imgElement = document.createElement('img');
                        imgElement.src = `data:image/png;base64,${prediction.bytesBase64Encoded}`;
                        imgElement.className = 'generated-image-option mx-auto rounded-lg shadow-lg';
                        imgElement.dataset.index = index;
                        imageGrid.appendChild(imgElement);
                    });
                    imageContainer.style.display = 'block';
                    regenerateBtn.style.display = 'inline-block';
                } else {
                    button.style.display = 'inline-block';
                }
            } catch(error) {
                 button.style.display = 'inline-block';
            } finally {
                loader.style.display = 'none';
            }
        }

        function selectGeneratedImage(imgElement, index) {
            document.querySelectorAll('.generated-image-option').forEach(img => img.classList.remove('selected'));
            imgElement.classList.add('selected');
            selected_generated_image_index = index;
        }

        // --- NEW GEMINI FEATURES ---
        async function getThemeIdeas() {
            const container = document.getElementById('theme-suggestions-container');
            const loader = document.getElementById('theme-suggestions-loader');
            const grid = document.getElementById('theme-suggestions-grid');
            container.style.display = 'block';
            loader.style.display = 'flex';
            grid.innerHTML = '';

            const prompt = `Generate exactly 3 creative and distinct theme ideas for a ${orderDetails.occasion} ${orderDetails.type}. For each theme, provide a "theme_name", a short "description", and a "keywords" string (e.g., "colors, elements, style").`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { theme_name: { type: "STRING" }, description: { type: "STRING" }, keywords: { type: "STRING" } }, required: ["theme_name", "description", "keywords"] } } } };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    JSON.parse(result.candidates[0].content.parts[0].text).forEach(theme => {
                        const card = document.createElement('div');
                        card.className = 'option-card border-2 bg-white/50 p-4 rounded-xl cursor-pointer';
                        card.innerHTML = `<h4 class="font-bold text-lg">${theme.theme_name}</h4><p class="text-sm">${theme.description}</p>`;
                        card.onclick = () => applyTheme(theme);
                        grid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error fetching theme ideas:', error);
            } finally {
                loader.style.display = 'none';
            }
        }

        function applyTheme(theme) {
            document.getElementById('customization').value = `Theme: ${theme.theme_name}.\nDescription: ${theme.description}\nKeywords for design: ${theme.keywords}.`;
            goToNextStep();
        }

        async function getFillingSuggestions() {
            const container = document.getElementById('filling-suggestions-container');
            const btn = document.getElementById('suggest-filling-btn');
            btn.disabled = true;
            btn.innerHTML = 'Thinking...';
            container.style.display = 'block';
            container.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';

            const prompt = `I am ordering a ${orderDetails.flavour} ${orderDetails.type}. Suggest 3 delicious and complementary fillings for it. For each, provide a one-sentence explanation of why the pairing works. Format as a simple numbered list.`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    const suggestions = result.candidates[0].content.parts[0].text.replace(/\d\.\s\*\*(.*?)\*\*:/g, '<p><strong>$1:</strong>').replace(/\n/g, '</p>');
                    container.innerHTML = `<h4 class="font-bold mb-2 text-stone-700">Expert Suggestions for a ${orderDetails.flavour} ${orderDetails.type}:</h4>${suggestions}`;
                }
            } catch (error) {
                console.error('Error fetching filling suggestions:', error);
            } finally {
                 btn.disabled = false;
                 btn.innerHTML = '‚ú® Get Expert Advice';
            }
        }

        // --- ENQUIRY ---
        async function sendEnquiry() {
            if (document.querySelectorAll('.generated-image-option').length > 0 && selected_generated_image_index === null) {
                alert("Please select your favorite preview image before sending the enquiry.");
                return;
            }

            const enquiryButton = document.getElementById('send-enquiry-button');
            enquiryButton.disabled = true;
            enquiryButton.innerHTML = 'Compressing Image & Sending...';

            if (selected_generated_image_index !== null) {
                const selectedImgElement = document.getElementById('generated-image-grid').children[selected_generated_image_index];
                try {
                    const compressedData = await compressImage(selectedImgElement.src);
                    orderDetails.selected_ai_preview_data = compressedData;
                } catch(error) {
                    alert('An error occurred while preparing your selected image. Please try again.');
                    enquiryButton.disabled = false;
                    enquiryButton.innerHTML = 'üìß Send Enquiry';
                    return;
                }
            }
            
            enquiryButton.innerHTML = 'Sending Enquiry...';
            const webhookUrl = 'https://connect.pabbly.com/workflow/sendwebhookfiledata/IjU3NjYwNTY1MDYzNDA0MzM1MjZhIg_3D_3D_pc/IjU3NjYwNTZiMDYzMjA0M2M1MjY0NTUzMzUxM2Ii_pc';
            const totalPrice = document.getElementById('total-price').innerText;
            const dataToSend = { ...orderDetails, estimatedPrice: totalPrice };

            try {
                await fetch(webhookUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(dataToSend) });
                document.getElementById('enquiry-section').style.display = 'none';
                document.getElementById('enquiry-confirmation').innerHTML = `<p class="font-semibold">Thank You!</p><p>Your enquiry has been sent successfully. We will be in touch shortly!</p>`;
                document.getElementById('enquiry-confirmation').style.display = 'block';
            } catch (error) {
                alert('Sorry, there was a problem sending your enquiry. Please try again or contact us directly.');
                enquiryButton.disabled = false;
                enquiryButton.innerHTML = 'üìß Send Enquiry';
            }
        }

        // --- RESET ---
        function resetCalculator() {
            Object.keys(orderDetails).forEach(key => orderDetails[key] = null);
            Object.keys(prices).forEach(key => prices[key] = 0);
            selected_generated_image_index = null;
            document.getElementById('cake-form').reset();
            document.querySelectorAll('.option-card, .generated-image-option').forEach(el => el.classList.remove('selected'));
            ['image-preview-container', 'generated-image-container', 'regenerate-button', 'theme-suggestions-container', 'filling-suggestions-container', 'enquiry-confirmation'].forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById('generate-button').style.display = 'inline-block';
            document.getElementById('enquiry-section').style.display = 'block';
            document.getElementById('send-enquiry-button').disabled = false;
            document.getElementById('send-enquiry-button').innerHTML = 'üìß Send Enquiry';
            updateSummary();
            updatePrice();
            goToStep(1);
        }

        // --- INITIALIZATION ---
        function initAutocomplete() {
            console.log("Google Maps Autocomplete disabled as no API key was provided.");
        }
        
        window.onload = function() {
            setMinDate();
            goToStep(1);
            
            // Event delegation for generated images
            document.getElementById('generated-image-grid').addEventListener('click', function(event) {
                const clickedImg = event.target.closest('.generated-image-option');
                if (clickedImg) {
                    const index = parseInt(clickedImg.dataset.index, 10);
                    selectGeneratedImage(clickedImg, index);
                }
            });
        };
    </script>
</body>
</html>
